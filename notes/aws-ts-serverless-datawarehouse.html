<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  
  <title>Aws Ts Serverless Datawarehouse - Dendron - Pulumi</title>
  

  <link
    rel="shortcut icon"
    href="https://pulumi.dendron.so/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="stylesheet"
    href="https://pulumi.dendron.so/assets/css/just-the-docs-default.css"
  />
  <script
    type="text/javascript"
    src="https://pulumi.dendron.so/assets/js/just-the-docs.js"
  ></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/themes/prism.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
    crossorigin="anonymous"
  />
  <script
    type="text/javascript"
    src="https://pulumi.dendron.so/assets/js/vendor/lunr.min.js"
  ></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
  
<meta name="description" content="Dendron Vault for Pulumi Examples">
<meta name="author" content="">

<link rel="canonical" href="https://pulumi.dendron.so/notes/aws-ts-serverless-datawarehouse.html">

<meta property="og:type" content="article">
<meta property="og:url" content="https://pulumi.dendron.so/notes/aws-ts-serverless-datawarehouse.html">
<meta property="og:description" content="Dendron Vault for Pulumi Examples">
<meta property="og:image" content="https://pulumi.dendron.soundefined">

<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://pulumi.dendron.so/notes/aws-ts-serverless-datawarehouse.html">
<meta name="twitter:description" content="Dendron Vault for Pulumi Examples">
<meta name="twitter:image" content="https://pulumi.dendron.soundefined">


  <meta property="og:title" content="Aws Ts Serverless Datawarehouse - Dendron - Pulumi" />
  <meta name="twitter:title" content="Aws Ts Serverless Datawarehouse - Dendron - Pulumi" />
  
</head>


<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
      </symbol>
      <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
          <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </symbol>
      <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
          <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </symbol>
      <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </symbol>
      <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      </symbol>
    </svg>

    <div class="side-bar">
      <div class="site-header">
        <a href="https://pulumi.dendron.so" class="site-title lh-tight">
  Dendron - Pulumi

 </a>
        <a href="#" id="menu-button" class="site-button">
          <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
        </a>
      </div>

      <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      </nav>
      <footer class="site-footer">
        ðŸŒ± with ðŸ’• using <a href="https://www.dendron.so/"> Dendron ðŸŒ² </a>
      </footer>
    </div>
    <div class="main" id="top">
        <div id="main-header" class="main-header">
          
            <div class="search">
              <div class="search-input-wrap">
                <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Dendron - Pulumi" aria-label="Search Dendron - Pulumi" autocomplete="off">
                <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
              </div>
              <div id="search-results" class="search-results"></div>
            </div>
          
          
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
          <nav aria-label="Breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://pulumi.dendron.so">Root</a></li><li class="breadcrumb-nav-list-item">Aws Ts Serverless Datawarehouse</li></ol>
          </nav>
        
      
      <div id="main-content" class="main-content" role="main">

        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

        
        <div class="alert alert-primary" role="alert">
          This page was generated from content adapted from the following <a href="#" data-html="true" data-toggle="popover" title="Attributions">sources</a>
          </a>
        </div>

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({content: `
              <ul>
              
              <li> <a href="https://github.com/pulumi/examples" target="_blank"> pulumi examples  </li>
              
              </ul>
            `})
          })
        </script>
        

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({html: true})
          })
        </script>

        

<div id="main" role="main">

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Aws Ts Serverless Datawarehouse">
    
    <meta itemprop="datePublished" content="2021-03-31T15:19:59+00:00">
    <meta itemprop="dateModified" content="2021-03-31T15:19:59+00:00">

    <div class="page__inner-wrap">

      

      <section class="page__content" itemprop="text">

        

        <h1 id="serverless-datawarehouse"><a aria-hidden="true" class="anchor-heading" href="#serverless-datawarehouse"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Serverless Datawarehouse</h1>
<p>A sample project that deploys a serverless data warehouse. This highly scalable data warehouse is pay as you go, scales read and write workload independently, and uses fully managed services.</p>
<p><img src="architecture.png" alt="Serverless Data Warehouse Architecture"></p>
<h2 id="deploy-and-run-the-program"><a aria-hidden="true" class="anchor-heading" href="#deploy-and-run-the-program"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Deploy and run the program</h2>
<ol>
<li>Create a new stack</li>
</ol>
<pre class="language-sh"><code class="language-sh">pulumi stack init dev
</code></pre>
<ol start="2">
<li>Install dependencies</li>
</ol>
<pre class="language-sh"><code class="language-sh">npm install
</code></pre>
<ol start="3">
<li>Deploy</li>
</ol>
<pre class="language-sh"><code class="language-sh">pulumi up
</code></pre>
<ol start="4">
<li>Open Athena in the AWS Console, and perform some queries:</li>
</ol>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> analytics_dw<span class="token punctuation">.</span>clicks<span class="token punctuation">;</span>
</code></pre>
<ol start="5">
<li>Clean up the stack</li>
</ol>
<pre><code>pulumi destroy
</code></pre>
<h2 id="testing"><a aria-hidden="true" class="anchor-heading" href="#testing"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Testing</h2>
<h3 id="unit-tests"><a aria-hidden="true" class="anchor-heading" href="#unit-tests"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Unit Tests</h3>
<pre class="language-sh"><code class="language-sh">npm run test:unit
</code></pre>
<h3 id="integration-tests"><a aria-hidden="true" class="anchor-heading" href="#integration-tests"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Integration Tests</h3>
<p>There is an integration test that deploys a fresh stack, ingests sample data, and verifies that the data can be queried on the other end through Athena. </p>
<p>Because <code>ServerlessDataWarehouse</code> statically names Glue Databases, the integration test will fail with a <code>409 conflict</code> if you already have a dev stack running.</p>
<pre class="language-sh"><code class="language-sh"># make sure you have run a pulumi destroy against your dev stack first
npm run test:int
</code></pre>
<h2 id="api"><a aria-hidden="true" class="anchor-heading" href="#api"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>API</h2>
<h3 id="serverlessdatawarehouse-class"><a aria-hidden="true" class="anchor-heading" href="#serverlessdatawarehouse-class"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a><code>ServerlessDataWarehouse: class</code></h3>
<p>A container for your data warehouse that creates and manages a Glue Database, an S3 Bucket to store data, and another S3 bucket for Athena query results.</p>
<h3 id="constructor"><a aria-hidden="true" class="anchor-heading" href="#constructor"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Constructor</h3>
<h4 id="serverlessdatawarehousename-string-args-datawarehouseargs-opts-pulumicomponentresourceoptions"><a aria-hidden="true" class="anchor-heading" href="#serverlessdatawarehousename-string-args-datawarehouseargs-opts-pulumicomponentresourceoptions"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a><code>ServerlessDataWarehouse(name: string, args?: DataWarehouseArgs, opts?: pulumi.ComponentResourceOptions)</code></h4>
<p>Parameters:</p>
<ul>
<li><code>name: string</code>: Name of the pulumi resource. Will also be used for the Glue Database.</li>
<li><code>args: DataWarehouseArgs</code>:
<ul>
<li><code>database?: aws.glue.CatalogDatabase</code>: optionally provide an existing Glue Database.</li>
<li><code>isDev?: boolean</code>: flag for development, enables force destroy on S3 buckets to simplify stack teardown. </li>
</ul>
</li>
</ul>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> dataWarehouse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ServerlessDataWarehouse</span></span><span class="token punctuation">(</span><span class="token string">"analytics_dw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// make available as pulumi stack output</span>
<span class="token keyword">export</span> dwBucket <span class="token operator">=</span> dataWarehouse<span class="token punctuation">.</span><span class="token property-access">dataWarehouseBucket</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="members"><a aria-hidden="true" class="anchor-heading" href="#members"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Members:</h3>
<ul>
<li><code>dataWarehouseBucket: aws.s3.bucket</code>: Bucket to store table data.</li>
<li><code>queryResultsBucket: aws.s3.Bucket</code>: Bucket used by Athena for query output. </li>
<li><code>database: aws.glue.CatalogDatabase</code>: Glue Database to hold all tables created through method calls.</li>
</ul>
<h3 id="methods"><a aria-hidden="true" class="anchor-heading" href="#methods"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Methods:</h3>
<h4 id="withtable-function"><a aria-hidden="true" class="anchor-heading" href="#withtable-function"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a><code>withTable: function</code></h4>
<p>Creats a glue table owned by creates a Glue Table owned by <code>this.database</code> configured to read data from <code>${this.dataWarehouseBucket}/${name}</code></p>
<p>Parameters:</p>
<ul>
<li><code>name: string</code>: The name of the table. The table will be configured to read data from <code>${this.dataWarehouseBucket}/${name}</code>.</li>
<li><code>args: TableArgs</code>: 
<ul>
<li><code>columns: input.glue.CatalogTableStorageDescriptorColumn[]</code>: Description of the schema.</li>
<li><code>partitionKeys?: input.glue.CatalogTablePartitionKey[]</code>: Partition keys to be associated with the schema. </li>
<li><code>dataFormat?: "JSON" | "parquet"</code>: Specifies the encoding of files written to <code>${this.dataWarehouseBucket}/${name}</code>. Defaults to parquet. Will be used to configure serializers and metadata that enable Athena and other engines to execute queries. </li>
</ul>
</li>
</ul>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> factTableName <span class="token operator">=</span> <span class="token string">"facts"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> factColumns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"thing"</span><span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">"string"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"color"</span><span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">"string"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> factTableArgs<span class="token operator">:</span> <span class="token maybe-class-name">TableArgs</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    columns<span class="token operator">:</span> factColumns<span class="token punctuation">,</span>
    dataFormat<span class="token operator">:</span> <span class="token string">"JSON"</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

dataWarehouse<span class="token punctuation">.</span><span class="token method function property-access">withTable</span><span class="token punctuation">(</span><span class="token string">"facts"</span><span class="token punctuation">,</span> factTableArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="withstreamingbatchinputtable-function"><a aria-hidden="true" class="anchor-heading" href="#withstreamingbatchinputtable-function"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a><code>withStreamingBatchInputTable: function</code></h4>
<p>Creates a table implements the above architecture diagram. It creates a Kinesis input stream for JSON records, a Glue Table, and Kinesis Firehose that vets JSON records against the schema, converts them to parquet, and writes files into hourly folders <code>${dataWarehouseBucket}/${tableName}/YYYY/MM/DD/HH</code>. Partitions are automatically registered for a key <code>inserted_at="YYYY/MM/DD/HH</code> to enable processing time queries. </p>
<p>Parameters: </p>
<ul>
<li><code>name: string</code>: The name of the table. The table will be configured to read data from <code>${this.dataWarehouseBucket}/${name}</code>.</li>
<li><code>args: StreamingInputTableArgs</code>
<ul>
<li><code>columns: input.glue.CatalogTableStorageDescriptorColumn[]</code>: Description of the schema.</li>
<li><code>inputStreamShardCount: number</code>: Number of shards to provision for the input Kinesis steam. This is how you scale your write workload.</li>
<li><code>region: string</code>: region to localize resources like Kinesis and Lambda</li>
<li><code>partitionKeyName?: string</code>: Name of the <code>YYYY/MM/DD/HH</code> partition key. Defaulst to <code>inserted_at</code>.</li>
<li><code>partitionScheduleExpression?: string</code> AWS Lambda cron expression used to schedule the job that writes partition keys to Glue. Defaults to <code>rate(1 hour)</code>. Useful for development or integration testing where you want to ensure that partitions are writtin in a timely manner. </li>
</ul>
</li>
<li><code>fileFlushIntervalSeconds?: number</code>: Period in seconds that Kinesis shards flush files to S3. Defaults to the max of 900 (15 minutes). Min 60 seconds. </li>
</ul>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> columns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">"string"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"session_id"</span><span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">"string"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"event_time"</span><span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">"string"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> impressionsTableName <span class="token operator">=</span> <span class="token string">"impressions"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> streamingTableArgs<span class="token operator">:</span> <span class="token maybe-class-name">StreamingInputTableArgs</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    columns<span class="token punctuation">,</span>
    inputStreamShardCount<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    region<span class="token operator">:</span> <span class="token string">"us-west-2"</span><span class="token punctuation">,</span>
    partitionScheduleExpression<span class="token operator">:</span> <span class="token string">"rate(1 minute)"</span><span class="token punctuation">,</span>
    fileFlushIntervalSeconds<span class="token operator">:</span> <span class="token number">60</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> dataWarehouse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ServerlessDataWarehouse</span></span><span class="token punctuation">(</span><span class="token string">"analytics_dw"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> isDev <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">withStreamingInputTable</span><span class="token punctuation">(</span><span class="token string">"impressions"</span><span class="token punctuation">,</span> streamingTableArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="withbatchinputtable-function"><a aria-hidden="true" class="anchor-heading" href="#withbatchinputtable-function"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a><code>withBatchInputTable: function</code></h4>
<p>Designed for batch loading tables on a regular cadence. Creates a Glue Table and executes the user specified function on the specified interval. Function runs inside of Lambda, and must be able to operate within the Lambda runtime constraints on memory, disk, and execution time. Runs with 3GB RAM, 500MB disk, and 15 min timeout. </p>
<p>Parameters: </p>
<ul>
<li><code>name: string</code>: The name of the table. The table will be configured to read data from <code>${this.dataWarehouseBucket}/${name}</code>.</li>
<li><code>args: BatchInputTableArgs</code>:
<ul>
<li><code>columns: input.glue.CatalogTableStorageDescriptorColumn[]</code>: Description of the schema.</li>
<li><code>partitionKeys?: input.glue.CatalogTablePartitionKey[]</code>: Partition keys to be associated with the schema. </li>
<li><code>jobFn: (event: EventRuleEvent) => any</code>: Code to be executed in the lambda that will write data to <code>${this.dataWarehouseBucket}/${name}</code>.</li>
<li><code>scheduleExpression: string</code>: AWS Lambda cron expression that <code>jobFn</code> will execute on.</li>
<li><code>policyARNsToAttach?: pulumi.Input&#x3C;ARN>[]</code>: List of ARNs needed by the Lambda role for <code>jobFn</code> to run successfully. (Athena access, S3 access, Glue access, etc).</li>
<li><code>dataFormat?: "JSON" | "parquet"</code>: Specifies the encoding of files written to <code>${this.dataWarehouseBucket}/${name}</code>. Defaults to parquet. Will be used to configure serializers and metadata that enable Athena and other engines to execute queries. </li>
</ul>
</li>
</ul>
<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> aggregateTableName <span class="token operator">=</span> <span class="token string">"aggregates"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> aggregateTableColumns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"event_type"</span><span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">"string"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"count"</span><span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">"int"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">"time"</span><span class="token punctuation">,</span>
        <span class="token keyword">type</span><span class="token operator">:</span> <span class="token string">"string"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Function reads from other tables via Athena and writes JSON to S3.</span>
<span class="token keyword">const</span> <span class="token function-variable function">aggregationFunction</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token maybe-class-name">EventRuleEvent</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> athena <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">"athena-client"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> bucketUri <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">s3://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>athenaResultsBucket<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> clientConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
        bucketUri
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> awsConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
        region
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> athenaClient <span class="token operator">=</span> athena<span class="token punctuation">.</span><span class="token method function property-access">createClient</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">,</span> awsConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> date <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">time</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> partitionKey <span class="token operator">=</span> date<span class="token punctuation">.</span><span class="token method function property-access">utc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">format</span><span class="token punctuation">(</span><span class="token string">"YYYY/MM/DD/HH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">getAggregateQuery</span> <span class="token operator">=</span> <span class="token punctuation">(</span>table<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">select count(*) from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>databaseName<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>table<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> where inserted_at='</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>partitionKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> clicksPromise <span class="token operator">=</span> athenaClient<span class="token punctuation">.</span><span class="token method function property-access">execute</span><span class="token punctuation">(</span><span class="token function">getAggregateQuery</span><span class="token punctuation">(</span>clicksTableName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> impressionsPromise <span class="token operator">=</span> athenaClient<span class="token punctuation">.</span><span class="token method function property-access">execute</span><span class="token punctuation">(</span><span class="token function">getAggregateQuery</span><span class="token punctuation">(</span>impressionsTableName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> clickRows <span class="token operator">=</span> <span class="token keyword">await</span> clicksPromise<span class="token punctuation">;</span>
    <span class="token keyword">const</span> impressionRows <span class="token operator">=</span> <span class="token keyword">await</span> impressionsPromise<span class="token punctuation">;</span>
    <span class="token keyword">const</span> clickCount <span class="token operator">=</span> clickRows<span class="token punctuation">.</span><span class="token property-access">records</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'_col0'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> impressionsCount <span class="token operator">=</span> impressionRows<span class="token punctuation">.</span><span class="token property-access">records</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'_col0'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">{ "event_type": "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>clicksTableName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">", "count": </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>clickCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, "time": "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>partitionKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" }\n{ "event_type": "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>impressionsTableName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">", "count": </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>impressionsCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, "time": "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>partitionKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> s3Client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">S3</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> s3Client<span class="token punctuation">.</span><span class="token method function property-access">putObject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token maybe-class-name">Bucket</span><span class="token operator">:</span> dwBucket<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token maybe-class-name">Key</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>aggregateTableName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>partitionKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/results.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token maybe-class-name">Body</span><span class="token operator">:</span> data
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> policyARNsToAttach<span class="token operator">:</span> pulumi<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Input</span></span><span class="token operator">&#x3C;</span><span class="token constant">ARN</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    aws<span class="token punctuation">.</span><span class="token property-access">iam</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">ManagedPolicies</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">AmazonAthenaFullAccess</span></span><span class="token punctuation">,</span>
    aws<span class="token punctuation">.</span><span class="token property-access">iam</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">ManagedPolicies</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">AmazonS3FullAccess</span></span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> aggregateTableArgs<span class="token operator">:</span> <span class="token maybe-class-name">BatchInputTableArgs</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    columns<span class="token operator">:</span> aggregateTableColumns<span class="token punctuation">,</span>
    jobFn<span class="token operator">:</span> aggregationFunction<span class="token punctuation">,</span>
    scheduleExpression<span class="token punctuation">,</span>
    policyARNsToAttach<span class="token punctuation">,</span>
    dataFormat<span class="token operator">:</span> <span class="token string">"JSON"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

dataWarehouse<span class="token punctuation">.</span><span class="token method function property-access">withBatchInputTable</span><span class="token punctuation">(</span>aggregateTableName<span class="token punctuation">,</span> aggregateTableArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="gettable-function"><a aria-hidden="true" class="anchor-heading" href="#gettable-function"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a><code>getTable: function</code></h4>
<p>Retrieves a table with the specified name.</p>
<p>Parameters: </p>
<ul>
<li><code>name: string</code> the name of the <code>ServerlessDataWarehouse</code> owned table to retrieve. </li>
</ul>
<h4 id="listtables-function"><a aria-hidden="true" class="anchor-heading" href="#listtables-function"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a><code>listTables: function</code></h4>
<p>Returns an array of table names managed by this data warehouse.</p>
<h4 id="getinputstream-function"><a aria-hidden="true" class="anchor-heading" href="#getinputstream-function"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a><code>getInputStream: function</code></h4>
<p>Retrieves the input stream associated with the specified table name, if any. </p>
<p>Parameters:</p>
<ul>
<li><code>tableName: string</code>: Name of the table to find an associated inputStream for. </li>
</ul>
<hr>
<h2 id="imported-assets"><a aria-hidden="true" class="anchor-heading" href="#imported-assets"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Imported Assets</h2>
<ul>
<li><a href="/assets/pulumi.yaml">Pulumi.yaml</a></li>
<li><a href="/assets/architecture.png">architecture.png</a></li>
<li><a href="/assets/index.ts">index.ts</a></li>
<li><a href="/assets/jest.js">jest.config.js</a></li>
<li><a href="/assets/package.json">package.json</a></li>
<li><a href="/assets/tsconfig.json">tsconfig.json</a></li>
</ul>
<hr>
<h2 id="children"><a aria-hidden="true" class="anchor-heading" href="#children"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Children</h2>
<ol>
<li><a href="https://pulumi.dendron.so/notes/aws-ts-serverless-datawarehouse.datawarehouse.html">Datawarehouse</a></li>
<li><a href="https://pulumi.dendron.so/notes/910b9f8d-a0c5-42bf-8eaa-dbc86a916c2c.html">Testing</a></li>
<li><a href="https://pulumi.dendron.so/notes/aws-ts-serverless-datawarehouse.utils.html">Utils</a></li>
<li><a href="https://pulumi.dendron.so/notes/aws-ts-serverless-datawarehouse.__tests__.html">__tests__</a></li>
</ol><span id="navId" data="aws-ts-serverless-datawarehouse"></span>

                
      </section>

      
    </div>

    
  </article>

  
  
</div>


        
          <hr>
          <footer>
            
            

            
                
                  <p class="text-small text-grey-dk-000 mb-0">
                    <a href="https://github.com/pulumi/examples/edit/master/aws-ts-serverless-datawarehouse/README.md" id="edit-this-page">Edit this page on GitHub</a>
                  </p>
                
              </div>
          </footer>
        
    </div>
</div>


  

  <div class="search-overlay"></div>

</div>
</body>
</html>
