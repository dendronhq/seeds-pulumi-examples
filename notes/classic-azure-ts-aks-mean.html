<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  
  <title>Classic Azure Ts Aks Mean - Dendron - Pulumi</title>
  

  <link
    rel="shortcut icon"
    href="https://pulumi.dendron.so/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="stylesheet"
    href="https://pulumi.dendron.so/assets/css/just-the-docs-default.css"
  />
  <script
    type="text/javascript"
    src="https://pulumi.dendron.so/assets/js/just-the-docs.js"
  ></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/themes/prism.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
    crossorigin="anonymous"
  />
  <script
    type="text/javascript"
    src="https://pulumi.dendron.so/assets/js/vendor/lunr.min.js"
  ></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
  
<meta name="description" content="Dendron Vault for Pulumi Examples">
<meta name="author" content="">

<link rel="canonical" href="https://pulumi.dendron.so/notes/classic-azure-ts-aks-mean.html">

<meta property="og:type" content="article">
<meta property="og:url" content="https://pulumi.dendron.so/notes/classic-azure-ts-aks-mean.html">
<meta property="og:description" content="Dendron Vault for Pulumi Examples">
<meta property="og:image" content="https://pulumi.dendron.soundefined">

<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://pulumi.dendron.so/notes/classic-azure-ts-aks-mean.html">
<meta name="twitter:description" content="Dendron Vault for Pulumi Examples">
<meta name="twitter:image" content="https://pulumi.dendron.soundefined">


  <meta property="og:title" content="Classic Azure Ts Aks Mean - Dendron - Pulumi" />
  <meta name="twitter:title" content="Classic Azure Ts Aks Mean - Dendron - Pulumi" />
  
</head>


<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
      </symbol>
      <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
          <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </symbol>
      <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
          <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </symbol>
      <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </symbol>
      <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      </symbol>
    </svg>

    <div class="side-bar">
      <div class="site-header">
        <a href="https://pulumi.dendron.so" class="site-title lh-tight">
  Dendron - Pulumi

 </a>
        <a href="#" id="menu-button" class="site-button">
          <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
        </a>
      </div>

      <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      </nav>
      <footer class="site-footer">
        ðŸŒ± with ðŸ’• using <a href="https://www.dendron.so/"> Dendron ðŸŒ² </a>
      </footer>
    </div>
    <div class="main" id="top">
        <div id="main-header" class="main-header">
          
            <div class="search">
              <div class="search-input-wrap">
                <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Dendron - Pulumi" aria-label="Search Dendron - Pulumi" autocomplete="off">
                <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
              </div>
              <div id="search-results" class="search-results"></div>
            </div>
          
          
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
          <nav aria-label="Breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://pulumi.dendron.so">Root</a></li><li class="breadcrumb-nav-list-item">Classic Azure Ts Aks Mean</li></ol>
          </nav>
        
      
      <div id="main-content" class="main-content" role="main">

        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

        
        <div class="alert alert-primary" role="alert">
          This page was generated from content adapted from the following <a href="#" data-html="true" data-toggle="popover" title="Attributions">sources</a>
          </a>
        </div>

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({content: `
              <ul>
              
              <li> <a href="https://github.com/pulumi/examples" target="_blank"> pulumi examples  </li>
              
              </ul>
            `})
          })
        </script>
        

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({html: true})
          })
        </script>

        

<div id="main" role="main">

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Classic Azure Ts Aks Mean">
    
    <meta itemprop="datePublished" content="2021-03-31T15:19:59+00:00">
    <meta itemprop="dateModified" content="2021-03-31T15:19:59+00:00">

    <div class="page__inner-wrap">

      

      <section class="page__content" itemprop="text">

        

        <p><a href="https://app.pulumi.com/new"><img src="https://get.pulumi.com/new/button.svg" alt="Deploy"></a></p>
<h1 id="azure-kubernetes-service-aks-app-using-cosmosdb"><a aria-hidden="true" class="anchor-heading" href="#azure-kubernetes-service-aks-app-using-cosmosdb"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Azure Kubernetes Service (AKS) App Using CosmosDB</h1>
<p>Stands up an <a href="https://azure.microsoft.com/en-us/services/kubernetes-service/">Azure Kubernetes Service</a> (AKS) cluster and a MongoDB-flavored instance of
<a href="https://azure.microsoft.com/en-us/services/cosmos-db/">CosmosDB</a>. On top of the AKS cluster, we also deploy <a href="https://www.helm.sh/">Helm</a> Chart with a simple
Node.js TODO app (<a href="https://github.com/bitnami/sample-mean"><code>bitnami/node</code></a>), swapping out the usual in-cluster MongoDB instance
with our managed CosmosDB instance.</p>
<h2 id="prerequisites"><a aria-hidden="true" class="anchor-heading" href="#prerequisites"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Prerequisites</h2>
<p>Ensure you have <a href="https://www.pulumi.com/docs/get-started/install/">downloaded and installed the Pulumi CLI</a>.</p>
<p>We will be deploying to Azure, so you will need an Azure account. If you don't have an account,
<a href="https://azure.microsoft.com/en-us/free/">sign up for free here</a>. <a href="https://www.pulumi.com/docs/intro/cloud-providers/azure/setup/">Follow the instructions
here</a> to connect Pulumi to your Azure account.</p>
<p>This example deploys a Helm Chart from <a href="https://github.com/bitnami/charts">Bitnami's Helm chart repository</a></p>
<p>Install dependencies:</p>
<pre class="language-sh"><code class="language-sh">npm install
</code></pre>
<h2 id="running-the-app"><a aria-hidden="true" class="anchor-heading" href="#running-the-app"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Running the App</h2>
<ol>
<li>
<p>Create a new stack:</p>
<pre class="language-sh"><code class="language-sh">$ pulumi stack init
Enter a stack name: azure-mean
</code></pre>
</li>
<li>
<p>Set the required configuration variables for this program:</p>
<pre class="language-bash"><code class="language-bash">$ pulumi config <span class="token builtin class-name">set</span> azure:environment public
$ pulumi config <span class="token builtin class-name">set</span> password --secret <span class="token punctuation">[</span>your-cluster-password-here<span class="token punctuation">]</span>
$ ssh-keygen -t rsa -f key.rsa
$ pulumi config <span class="token builtin class-name">set</span> sshPublicKey <span class="token operator">&#x3C;</span> key.rsa.pub
$ az login
</code></pre>
</li>
<li>
<p>Perform the deployment:</p>
<blockquote>
<p><strong>Note</strong>: Due to an <a href="https://github.com/terraform-providers/terraform-provider-azuread/issues/156">issue</a> in Azure Terraform Provider, the
creation of an Azure Service Principal, which is needed to create the Kubernetes cluster (see cluster.ts), is delayed and may not
be available when the cluster is created.  If you get a "Service Principal not found" error, as a work around, you should be able to run <code>pulumi up</code>
again, at which time the Service Principal replication should have been completed. See <a href="https://github.com/Azure/AKS/issues/1206">this issue</a> and
<a href="https://docs.microsoft.com/en-us/azure/aks/troubleshooting#im-receiving-errors-that-my-service-principal-was-not-found-when-i-try-to-create-a-new-cluster-without-passing-in-an-existing-one">this doc</a>
for further details.</p>
</blockquote>
<pre class="language-sh"><code class="language-sh">$ pulumi up
Updating stack 'azure-mean'
Performing changes:

     Type                                         Name                   Status      Info
 +   pulumi:pulumi:Stack                          azure-mean-azure-mean  created     1 warning
 +   â”œâ”€ azure:core:ResourceGroup                  aks                    created
 +   â”œâ”€ azure:ad:Application                      aks                    created
 +   â”œâ”€ azure:ad:ServicePrincipal                 aksSp                  created
 +   â”œâ”€ azure:ad:ServicePrincipalPassword         aksSpPassword          created
 +   â”œâ”€ azure:cosmosdb:Account                    cosmosDb               created
 +   â”œâ”€ azure:containerservice:KubernetesCluster  aksCluster             created
 +   â”œâ”€ pulumi:providers:kubernetes               aksK8s                 created
 +   â”œâ”€ kubernetes:core:Secret                    mongo-secrets          created
 +   â””â”€ kubernetes:helm.sh:Chart                  node                   created
 +      â”œâ”€ kubernetes:core:Service                node-node              created
 +      â””â”€ kubernetes:extensions:Deployment       node-node              created

---outputs:---
cluster        : "aksclusterbfb9388b"
frontendAddress: "40.76.25.71"

info: 12 changes performed:
    + 12 resources created
Update duration: 14m33.922322098s

Permalink: https://app.pulumi.com/hausdorff/azure-mean/updates/1
</code></pre>
<p>We can see here in the <code>---outputs:---</code> section that our Node.js appwas allocated a public IP,
in this case <code>40.76.25.71</code>. It is exported with a stack output variable, <code>frontendAddress</code>. We
can use <code>curl</code> and <code>grep</code> to retrieve the <code>&#x3C;title></code> of the site the proxy points at.</p>
<pre class="language-sh"><code class="language-sh">$ curl -sL $(pulumi stack output frontendAddress) | grep "&#x3C;title>"
    &#x3C;title>Node/Angular Todo App&#x3C;/title>>
</code></pre>
</li>
</ol>
<h2 id="next-steps"><a aria-hidden="true" class="anchor-heading" href="#next-steps"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Next steps</h2>
<p>One of the interesting aspects of this example is the way it demonstrates how easy it is to use
Azure resources to configure Kubernetes resources, without the need for intermediate APIs such as
<a href="https://osba.sh/">OSBA</a>. In particular, this example uses the connection strings exposed by the
CosmosDB instance to configure the <code>bitnami/node</code> Helm Chart to connect to CosmosDB, instead of
creating and connecting to an in-cluster MongoDB instance.</p>
<p>In <code>index.ts</code>, we see the MongoDB-flavored CosmosDB resource definition:</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Create a MongoDB-flavored instance of CosmosDB.</span>
<span class="token keyword">const</span> cosmosdb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">azure<span class="token punctuation">.</span>cosmosdb<span class="token punctuation">.</span>Account</span><span class="token punctuation">(</span><span class="token string">"cosmosDb"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    kind<span class="token operator">:</span> <span class="token string">"MongoDB"</span><span class="token punctuation">,</span>
    resourceGroupName<span class="token operator">:</span> config<span class="token punctuation">.</span><span class="token property-access">resourceGroup</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span>
    <span class="token dom variable">location</span><span class="token operator">:</span> config<span class="token punctuation">.</span><span class="token property-access">location</span><span class="token punctuation">,</span>
    consistencyPolicy<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    offerType<span class="token operator">:</span> <span class="token string">"Standard"</span><span class="token punctuation">,</span>
    enableAutomaticFailover<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    geoLocations<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token spread operator">...</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>And then subsequently, in the same file, we see that we use this CosmosDB object to create a
Kubernetes <code>Secret</code> containing the connection credentials, which is then consumed by the
<code>bitnami/node</code> Helm chart to connect.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token comment">// Create secret from MongoDB connection string.</span>
<span class="token keyword">const</span> mongoConnStrings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">k8s<span class="token punctuation">.</span>core<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>Secret</span><span class="token punctuation">(</span>
    <span class="token string">"mongo-secrets"</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        metadata<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"mongo-secrets"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> mongoHelpers<span class="token punctuation">.</span><span class="token method function property-access">parseConnString</span><span class="token punctuation">(</span>cosmosdb<span class="token punctuation">.</span><span class="token property-access">connectionStrings</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> provider<span class="token operator">:</span> k8sProvider <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Boot up nodejs Helm chart example using CosmosDB in place of in-cluster MongoDB.</span>
<span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">k8s<span class="token punctuation">.</span>helm<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>Chart</span><span class="token punctuation">(</span>
    <span class="token string">"node"</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        repo<span class="token operator">:</span> <span class="token string">"bitnami"</span><span class="token punctuation">,</span>
        chart<span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>
        version<span class="token operator">:</span> <span class="token string">"4.0.1"</span><span class="token punctuation">,</span>
        values<span class="token operator">:</span> <span class="token punctuation">{</span>
            serviceType<span class="token operator">:</span> <span class="token string">"LoadBalancer"</span><span class="token punctuation">,</span>
            mongodb<span class="token operator">:</span> <span class="token punctuation">{</span> install<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            externaldb<span class="token operator">:</span> <span class="token punctuation">{</span> ssl<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> secretName<span class="token operator">:</span> <span class="token string">"mongo-secrets"</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> providers<span class="token operator">:</span> <span class="token punctuation">{</span> kubernetes<span class="token operator">:</span> k8sProvider <span class="token punctuation">}</span><span class="token punctuation">,</span> dependsOn<span class="token operator">:</span> mongoConnStrings <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<hr>
<h2 id="imported-assets"><a aria-hidden="true" class="anchor-heading" href="#imported-assets"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Imported Assets</h2>
<ul>
<li><a href="/assets/pulumi.yaml">Pulumi.yaml</a></li>
<li><a href="/assets/cluster.ts">cluster.ts</a></li>
<li><a href="/assets/config.ts">config.ts</a></li>
<li><a href="/assets/index.ts">index.ts</a></li>
<li><a href="/assets/mongohelpers.ts">mongoHelpers.ts</a></li>
<li><a href="/assets/package.json">package.json</a></li>
<li><a href="/assets/tsconfig.json">tsconfig.json</a></li>
</ul><span id="navId" data="classic-azure-ts-aks-mean"></span>

                
      </section>

      
    </div>

    
  </article>

  
  
</div>


        
          <hr>
          <footer>
            
            

            
                
                  <p class="text-small text-grey-dk-000 mb-0">
                    <a href="https://github.com/pulumi/examples/edit/master/classic-azure-ts-aks-mean/README.md" id="edit-this-page">Edit this page on GitHub</a>
                  </p>
                
              </div>
          </footer>
        
    </div>
</div>


  

  <div class="search-overlay"></div>

</div>
</body>
</html>
