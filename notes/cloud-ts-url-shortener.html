<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  
  <title>Cloud Ts URL Shortener - Dendron - Pulumi</title>
  

  <link
    rel="shortcut icon"
    href="https://pulumi.dendron.so/favicon.ico"
    type="image/x-icon"
  />
  <link
    rel="stylesheet"
    href="https://pulumi.dendron.so/assets/css/just-the-docs-default.css"
  />
  <script
    type="text/javascript"
    src="https://pulumi.dendron.so/assets/js/just-the-docs.js"
  ></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.22.0/themes/prism.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
    integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X"
    crossorigin="anonymous"
  />
  <script
    type="text/javascript"
    src="https://pulumi.dendron.so/assets/js/vendor/lunr.min.js"
  ></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
  
<meta name="description" content="Dendron Vault for Pulumi Examples">
<meta name="author" content="">

<link rel="canonical" href="https://pulumi.dendron.so/notes/cloud-ts-url-shortener.html">

<meta property="og:type" content="article">
<meta property="og:url" content="https://pulumi.dendron.so/notes/cloud-ts-url-shortener.html">
<meta property="og:description" content="Dendron Vault for Pulumi Examples">
<meta property="og:image" content="https://pulumi.dendron.soundefined">

<meta name="twitter:card" content="summary">

<meta name="twitter:url" content="https://pulumi.dendron.so/notes/cloud-ts-url-shortener.html">
<meta name="twitter:description" content="Dendron Vault for Pulumi Examples">
<meta name="twitter:image" content="https://pulumi.dendron.soundefined">


  <meta property="og:title" content="Cloud Ts URL Shortener - Dendron - Pulumi" />
  <meta name="twitter:title" content="Cloud Ts URL Shortener - Dendron - Pulumi" />
  
</head>


<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
      <symbol id="svg-link" viewBox="0 0 24 24">
        <title>Link</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
        </svg>
      </symbol>
      <symbol id="svg-search" viewBox="0 0 24 24">
        <title>Search</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
          <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
      </symbol>
      <symbol id="svg-menu" viewBox="0 0 24 24">
        <title>Menu</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
          <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </symbol>
      <symbol id="svg-arrow-right" viewBox="0 0 24 24">
        <title>Expand</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </symbol>
      <symbol id="svg-doc" viewBox="0 0 24 24">
        <title>Document</title>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
        </svg>
      </symbol>
    </svg>

    <div class="side-bar">
      <div class="site-header">
        <a href="https://pulumi.dendron.so" class="site-title lh-tight">
  Dendron - Pulumi

 </a>
        <a href="#" id="menu-button" class="site-button">
          <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
        </a>
      </div>

      <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      </nav>
      <footer class="site-footer">
        ðŸŒ± with ðŸ’• using <a href="https://www.dendron.so/"> Dendron ðŸŒ² </a>
      </footer>
    </div>
    <div class="main" id="top">
        <div id="main-header" class="main-header">
          
            <div class="search">
              <div class="search-input-wrap">
                <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Dendron - Pulumi" aria-label="Search Dendron - Pulumi" autocomplete="off">
                <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
              </div>
              <div id="search-results" class="search-results"></div>
            </div>
          
          
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
          <nav aria-label="Breadcrumb" class="breadcrumb-nav">
            <ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://pulumi.dendron.so">Root</a></li><li class="breadcrumb-nav-list-item">Cloud Ts URL Shortener</li></ol>
          </nav>
        
      
      <div id="main-content" class="main-content" role="main">

        
        

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

        
        <div class="alert alert-primary" role="alert">
          This page was generated from content adapted from the following <a href="#" data-html="true" data-toggle="popover" title="Attributions">sources</a>
          </a>
        </div>

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({content: `
              <ul>
              
              <li> <a href="https://github.com/pulumi/examples" target="_blank"> pulumi examples  </li>
              
              </ul>
            `})
          })
        </script>
        

        <script>
          $(function () {
            $('[data-toggle="popover"]').popover({html: true})
          })
        </script>

        

<div id="main" role="main">

  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Cloud Ts URL Shortener">
    
    <meta itemprop="datePublished" content="2021-03-31T15:19:59+00:00">
    <meta itemprop="dateModified" content="2021-03-31T15:19:59+00:00">

    <div class="page__inner-wrap">

      

      <section class="page__content" itemprop="text">

        

        <p><a href="https://app.pulumi.com/new"><img src="https://get.pulumi.com/new/button.svg" alt="Deploy"></a></p>
<h1 id="serverless-url-shortener"><a aria-hidden="true" class="anchor-heading" href="#serverless-url-shortener"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Serverless URL Shortener</h1>
<p>This example demonstrates a complete URL shortener web application using high-level <code>cloud.Table</code> and
<code>cloud.HttpEndpoint</code> components, highlighting the ability to combine deployment time and runtime code, and the simple,
cloud-agnostic, programming model of <code>@pulumi/cloud</code>.  Although we only support AWS today in this framework, our plan
is to offer an implementation of this on all major clouds, and so any code targeting this can truly run anywhere.</p>
<h2 id="deploying-and-running-the-program"><a aria-hidden="true" class="anchor-heading" href="#deploying-and-running-the-program"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Deploying and running the program</h2>
<p>Note: some values in this example will be different from run to run.  These values are indicated
with <code>***</code>.</p>
<ol>
<li>
<p>Create a new stack:</p>
<pre><code>$ pulumi stack init url-shortener-test
</code></pre>
</li>
<li>
<p>Set the AWS region:</p>
<pre><code>$ pulumi config set aws:region us-west-2
</code></pre>
</li>
<li>
<p>Restore NPM modules via <code>npm install</code> or <code>yarn install</code>.</p>
</li>
<li>
<p>Preview and run the deployment via <code>pulumi up</code>. The operation will take about 2 minutes to
complete and will create 34 resources:</p>
<pre><code>$ pulumi up
Previewing update of stack 'url-shortener-dev'
...

Do you want to perform this update? yes
Updating stack 'url-shortener-dev'
Performing changes:

    Type                                      Name                                    Status      Info
+   pulumi:pulumi:Stack                       url-shortener-url-shortener-dev         created
+   â”œâ”€ cloud:table:Table                      urls                                    created
+   â”‚  â””â”€ aws:dynamodb:Table                  urls                                    created
+   â””â”€ cloud:http:HttpEndpoint                urlshortener                            created
+      â”œâ”€ aws:s3:Bucket                       urlshortener                            created
+      â”œâ”€ aws:iam:Role                        urlshortener4c238266                    created
+      â”œâ”€ cloud:function:Function             urlshortener0f7d8d8d                    created
+      â”‚  â””â”€ aws:serverless:Function          urlshortener0f7d8d8d                    created
+      â”‚     â”œâ”€ aws:iam:Role                  urlshortener0f7d8d8d                    created
+      â”‚     â”œâ”€ aws:iam:RolePolicyAttachment  urlshortener0f7d8d8d-32be53a2           created
+      â”‚     â”œâ”€ aws:iam:RolePolicyAttachment  urlshortener0f7d8d8d-fd1a00e5           created
+      â”‚     â””â”€ aws:lambda:Function           urlshortener0f7d8d8d                    created
+      â”œâ”€ cloud:function:Function             urlshortenerd9505e4a                    created
+      â”‚  â””â”€ aws:serverless:Function          urlshortenerd9505e4a                    created
+      â”‚     â”œâ”€ aws:iam:Role                  urlshortenerd9505e4a                    created
+      â”‚     â”œâ”€ aws:iam:RolePolicyAttachment  urlshortenerd9505e4a-32be53a2           created
+      â”‚     â”œâ”€ aws:iam:RolePolicyAttachment  urlshortenerd9505e4a-fd1a00e5           created
+      â”‚     â””â”€ aws:lambda:Function           urlshortenerd9505e4a                    created
+      â”œâ”€ cloud:function:Function             urlshortenereeb67ce9                    created
+      â”‚  â””â”€ aws:serverless:Function          urlshortenereeb67ce9                    created
+      â”‚     â”œâ”€ aws:iam:Role                  urlshortenereeb67ce9                    created
+      â”‚     â”œâ”€ aws:iam:RolePolicyAttachment  urlshortenereeb67ce9-32be53a2           created
+      â”‚     â”œâ”€ aws:iam:RolePolicyAttachment  urlshortenereeb67ce9-fd1a00e5           created
+      â”‚     â””â”€ aws:lambda:Function           urlshortenereeb67ce9                    created
+      â”œâ”€ aws:s3:BucketObject                 urlshortener4c238266/bootstrap.min.css  created
+      â”œâ”€ aws:s3:BucketObject                 urlshortener4c238266/favicon.png        created
+      â”œâ”€ aws:s3:BucketObject                 urlshortener4c238266/index.html         created
+      â”œâ”€ aws:iam:RolePolicyAttachment        urlshortener4c238266                    created
+      â”œâ”€ aws:apigateway:RestApi              urlshortener                            created
+      â”œâ”€ aws:apigateway:Deployment           urlshortener                            created
+      â”œâ”€ aws:lambda:Permission               urlshortener-0f7d8d8d                   created
+      â”œâ”€ aws:lambda:Permission               urlshortener-eeb67ce9                   created
+      â”œâ”€ aws:lambda:Permission               urlshortener-d9505e4a                   created
+      â””â”€ aws:apigateway:Stage                urlshortener                            created

---outputs:---
endpointUrl: "https://***.us-west-2.amazonaws.com/stage/"

info: 34 changes performed:
    + 34 resources created
Update duration: ***

Permalink: https://app.pulumi.com/***
</code></pre>
</li>
<li>
<p>To view the url for the API endpoint, run <code>pulumi stack output</code>:</p>
<pre><code>$ pulumi stack output endpointUrl
https://***.us-east-1.amazonaws.com/stage/
</code></pre>
</li>
<li>
<p>Open the URL in a browser and you'll see a single page app for creating and viewing short URLs.</p>
</li>
</ol>
<h3 id="logging"><a aria-hidden="true" class="anchor-heading" href="#logging"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Logging</h3>
<p>To view aggregated logs of the running application, use the <code>pulumi logs</code> command. These are logs across all of the compute for the application---in this case, 3 Lambda functions. To view a log stream, use the <code>--follow</code> flag:</p>
<pre><code>$ pulumi logs --follow
Collecting logs since 2018-03-27T18:20:32.000-07:00.

 2018-03-27T19:20:23.300-07:00[          urlshortener0f7d8d8d] GET /url retrieved 0 items
 2018-03-27T19:20:29.500-07:00[          urlshortenereeb67ce9] POST /url/a => https://www.lindydonna.com
 2018-03-27T19:20:29.885-07:00[          urlshortener0f7d8d8d] GET /url retrieved 1 items
 2018-03-27T19:20:36.879-07:00[          urlshortener0f7d8d8d] GET /url retrieved 1 items
</code></pre>
<h2 id="clean-up"><a aria-hidden="true" class="anchor-heading" href="#clean-up"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Clean up</h2>
<p>To clean up resources, run <code>pulumi destroy</code> and answer the confirmation question at the prompt.</p>
<h2 id="about-the-code"><a aria-hidden="true" class="anchor-heading" href="#about-the-code"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>About the code</h2>
<p>This example combines deployment time and runtime code in the same application. In <a href="./index.ts">index.ts</a>, there are two resource definitions at the top:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Create a web server.</span>
<span class="token keyword">let</span> endpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">cloud</span><span class="token punctuation">.</span><span class="token constant">API</span><span class="token punctuation">(</span><span class="token string">"urlshortener"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Create a table `urls`, with `name` as primary key.</span>
<span class="token keyword">let</span> urlTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">cloud</span><span class="token punctuation">.</span><span class="token method function property-access"><span class="token maybe-class-name">Table</span></span><span class="token punctuation">(</span><span class="token string">"urls"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>During <code>pulumi up</code>, the declaration <code>new cloud.API</code> provisions an AWS API Gateway resource and <code>new cloud.Table</code> provisions a Dynamo DB instance. To learn more about how this works, see <a href="https://www.pulumi.com/docs/intro/concepts/how-pulumi-works/">How Pulumi Works</a> in the documentation.</p>
<p>The <code>endpoint.get</code> and <code>endpoint.post</code> method calls cause Pulumi to register API routes on the API Gateway, pointing to an AWS Lambda function for each implementation:</p>
<pre class="language-typescript"><code class="language-typescript">endpoint<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"/url"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span> <span class="token comment">// this function is the body of the Lambda</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> items <span class="token operator">=</span> <span class="token keyword">await</span> urlTable<span class="token punctuation">.</span><span class="token method function property-access">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// reference outer urlTable definition</span>
        res<span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">GET /url retrieved </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>items<span class="token punctuation">.</span><span class="token property-access">length</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> items</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token property-access">stack</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">GET /url error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token punctuation">.</span><span class="token property-access">stack</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Pulumi creates a Lambda function that contains the anonymous function passed to <code>endpoint.get</code>. Note that the value of <code>urlTable</code> is "captured." This means that <code>urlTable.scan</code> is turned into an API call on Dynamo DB, using the physical identifier for <code>urlTable</code>. There's no need to store this information in an environment variable; Pulumi wires everything up for you.</p>
<p>To learn more about runtime and deployment time code, see <a href="https://www.pulumi.com/docs/intro/concepts/">Architecture and Concepts</a> in the Pulumi documentation.</p>
<hr>
<h2 id="imported-assets"><a aria-hidden="true" class="anchor-heading" href="#imported-assets"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Imported Assets</h2>
<ul>
<li><a href="/assets/pulumi.yaml">Pulumi.yaml</a></li>
<li><a href="/assets/index.ts">index.ts</a></li>
<li><a href="/assets/package.json">package.json</a></li>
<li><a href="/assets/tsconfig.json">tsconfig.json</a></li>
</ul>
<hr>
<h2 id="children"><a aria-hidden="true" class="anchor-heading" href="#children"><svg aria-hidden="true" viewBox="0 0 16 16"><use xlink:href="#svg-link"></use></svg></a>Children</h2>
<ol>
<li><a href="https://pulumi.dendron.so/notes/cloud-ts-url-shortener.www.html">Www</a></li>
</ol><span id="navId" data="cloud-ts-url-shortener"></span>

                
      </section>

      
    </div>

    
  </article>

  
  
</div>


        
          <hr>
          <footer>
            
            

            
                
                  <p class="text-small text-grey-dk-000 mb-0">
                    <a href="https://github.com/pulumi/examples/edit/master/cloud-ts-url-shortener/README.md" id="edit-this-page">Edit this page on GitHub</a>
                  </p>
                
              </div>
          </footer>
        
    </div>
</div>


  

  <div class="search-overlay"></div>

</div>
</body>
</html>
